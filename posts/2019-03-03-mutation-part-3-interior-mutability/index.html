<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><link href=//gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.54.0"><meta name=viewport content="width=device-width,initial-scale=1"><title>Mutation - part 3: Interior Mutability &middot; Another one bytes the Rust!</title><link type=text/css rel=stylesheet href=https://danielhenrymantilla.github.io/css/prev-next_buttons.css><link type=text/css rel=stylesheet href=https://danielhenrymantilla.github.io/css/inline_svgs.css><link type=text/css rel=stylesheet href=https://danielhenrymantilla.github.io/css/print.css media=print><link type=text/css rel=stylesheet href=https://danielhenrymantilla.github.io/css/poole.css><link type=text/css rel=stylesheet href=https://danielhenrymantilla.github.io/css/syntax.css><link type=text/css rel=stylesheet href=https://danielhenrymantilla.github.io/css/hyde.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png><link href rel=alternate type=application/rss+xml title="Another one bytes the Rust!"></head><body class="theme-base-08 layout-reverse"><aside class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://danielhenrymantilla.github.io/><h1>Another one bytes the Rust!</h1></a><p class=lead>Thoughts and ramblings for the like-minded</p></div><nav><ul class=sidebar-nav><li><a href=https://danielhenrymantilla.github.io/>Home</a></li><li><a href=/series>Blog Post Series</a></li><li><a href=/categories>Categories</a></li><li><a href=/tags>Tags</a></li></ul></nav><p>&copy; 2019. All rights reserved.</p></div></aside><main class="content container"><div class=prev-next><a class="prev-next-link prev-link" href=/posts/2019-02-24-mutation-part-2-to-mut-or-not-to-mut/><button class="button prev-button">
<span>Prev post</span></button></a></div><div class=post><h1>Mutation - part 3: Interior Mutability</h1><time datetime=2019-03-03T23:28:36&#43;0100 class=post-date>Sun, Mar 3, 2019</time><h1 style=display:none>Interior Mutability</h1><p><img src=https://i.imgflip.com/2v22n0.jpg alt="Interior Mutability"></p><h2 id=unsafecell-and-interior-mutability><code>&amp;UnsafeCell&lt;_&gt;</code> and &ldquo;Interior Mutability&rdquo;</h2><p>From the previous post, we have the following safe tranformation</p><blockquote><p><code>&amp;UnsafeCell&lt;T&gt; -&gt; *mut T</code></p></blockquote><p>So, <code>UnsafeCell&lt;_&gt;</code> wraps data and provides a handle to its interior, with which we can mutate the wrapped data; in other words, <strong>the <em>interior</em> of the wrapper is <em>mutable</em></strong>, even when the reference to the <code>UnsafeCell&lt;_&gt;</code> is not guaranteed to be unique.</p><p>This is extremely useful, since it is the only way to mutate <em>aliased data</em>.</p><h3 id=aliased-data>Aliased data</h3><p>We say that data is aliased / shared when it may be accessed from multiple variables or places:</p><ul><li><p>a <strong><code>static</code> variable</strong> can be accessed from anywhere<sup class=footnote-ref id=fnref:2><a href=#fn:2>1</a></sup> at anytime, and is thus always considered <em>shared</em>.</p></li><li><p>a <strong>variable being borrowed with a <code>&amp; _</code> reference</strong> (hence my calling them <code>&amp;shared _</code>).</p><p>This may be necessary when sharing data accross threads.
Imagine, for instance, that you have a big <code>String</code> that you want to read from accross two places (in this case, two different threads), and you don&rsquo;t want to needlessly copy it. The solution? you borrow it twice by creating two <code>&amp;shared String</code> references out of it, and then process to <code>move</code> each one to one of the threads.</p><a class=inline-svg href="https://play.rust-lang.org/?edition=2018&code=use%20%3a%3astd%3a%3a%7b%0a%20%20%20%20thread%2c%0a%20%20%20%20time%3a%3aDuration%2c%0a%7d%3b%0a%0ause%20%3a%3acrossbeam%3a%3ascope%3b%20%2f%2f%20v%200.7.1%20as%20of%20this%20writing%0a%0afn%20slow_repeat%20%28n_times%3a%20usize%2c%20mut%20f%3a%20impl%20FnMut%28%29%29%0a%7b%0a%20%20%20%20f%28%29%3b%0a%20%20%20%20%281%20..%20n_times%29.for_each%28%7c_%7c%20%7b%0a%20%20%20%20%20%20%20%20thread%3a%3asleep%28Duration%3a%3afrom_millis%2850%29%29%3b%0a%20%20%20%20%20%20%20%20f%28%29%3b%0a%20%20%20%20%7d%29%0a%7d%0a%0afn%20main%20%28%29%0a%7b%0a%20%20%20%20let%20big_string%3a%20String%20%3d%20%22SPAM%22.repeat%281_000%29%3b%0a%20%20%20%20scope%28%7cscope%7c%20%7b%0a%20%20%20%20%20%20%20%20let%20ref_1%3a%20%26%2f%2ashared%2a%2f%20String%20%3d%20%26big_string%3b%0a%20%20%20%20%20%20%20%20let%20ref_2%3a%20%26%2f%2ashared%2a%2f%20String%20%3d%20%26big_string%3b%0a%0a%20%20%20%20%20%20%20%20%2f%2f%20Thread1%0a%20%20%20%20%20%20%20%20scope.spawn%28move%20%2f%2a%20ref_1%20%2a%2f%20%7c_%7c%20%7b%0a%20%20%20%20%20%20%20%20%20%20%20%20let%20thread_id%20%3d%20thread%3a%3acurrent%28%29.id%28%29%3b%0a%20%20%20%20%20%20%20%20%20%20%20%20slow_repeat%2810%2c%20%7c%7c%20println%21%28%22%5b%7b%3a%3f%7d%5d%20%7b%7d%22%2c%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20thread_id%2c%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2aref_1%2c%20%2f%2f%20read%20the%20string%20data%0a%20%20%20%20%20%20%20%20%20%20%20%20%29%29%3b%0a%20%20%20%20%20%20%20%20%7d%29%3b%0a%0a%20%20%20%20%20%20%20%20%2f%2f%20Thread2%0a%20%20%20%20%20%20%20%20scope.spawn%28move%20%2f%2a%20ref_2%20%2a%2f%20%7c_%7c%20%7b%0a%20%20%20%20%20%20%20%20%20%20%20%20let%20thread_id%20%3d%20thread%3a%3acurrent%28%29.id%28%29%3b%0a%20%20%20%20%20%20%20%20%20%20%20%20slow_repeat%2810%2c%20%7c%7c%20println%21%28%22%5b%7b%3a%3f%7d%5d%20%7b%7d%22%2c%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20thread_id%2c%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2aref_2%2c%20%2f%2f%20read%20the%20string%20data%0a%20%20%20%20%20%20%20%20%20%20%20%20%29%29%3b%0a%20%20%20%20%20%20%20%20%7d%29%3b%0a%20%20%20%20%7d%29%20%20%2f%2f%20automagically%20joins%20all%20the%20scoped%20threads%0a%20%20%20%20%20%20%20%20.expect%28%22Some%20thread%20panicked%22%29%3b%0a%7d%0a" target=_blank><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="#606060" d="M424.4 214.7 72.4 6.6C43.8-10.3.0 6.1.0 47.9V464c0 37.5 40.7 60.1 72.4 41.3l352-208c31.4-18.5 31.5-64.1.0-82.6z"/></svg></a><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Rust data-lang=Rust><span style=color:#080;font-weight:700>use</span><span style=color:#bbb> </span>::std::{<span style=color:#bbb>
</span><span style=color:#bbb>    </span>thread,<span style=color:#bbb>
</span><span style=color:#bbb>    </span>time::Duration,<span style=color:#bbb>
</span><span style=color:#bbb></span>};<span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#080;font-weight:700>use</span><span style=color:#bbb> </span>::crossbeam::scope;<span style=color:#bbb> </span><span style=color:#888>// v 0.7.1 as of this writing
</span><span style=color:#888></span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#080;font-weight:700>fn</span> <span style=color:#06b;font-weight:700>slow_repeat</span><span style=color:#bbb> </span>(n_times: <span style=color:#339;font-weight:700>usize</span>,<span style=color:#bbb> </span><span style=color:#080;font-weight:700>mut</span><span style=color:#bbb> </span>f: <span style=color:#b06;font-weight:700>impl</span><span style=color:#bbb> </span><span style=color:#007020>FnMut</span>())<span style=color:#bbb>
</span><span style=color:#bbb></span>{<span style=color:#bbb>
</span><span style=color:#bbb>    </span>f();<span style=color:#bbb>
</span><span style=color:#bbb>    </span>(<span style=color:#00d;font-weight:700>1</span><span style=color:#bbb> </span>..<span style=color:#bbb> </span>n_times).for_each(<span style=color:#333>|</span>_<span style=color:#333>|</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span><span style=color:#bbb>        </span>thread::sleep(Duration::from_millis(<span style=color:#00d;font-weight:700>50</span>));<span style=color:#bbb>
</span><span style=color:#bbb>        </span>f();<span style=color:#bbb>
</span><span style=color:#bbb>    </span>})<span style=color:#bbb>
</span><span style=color:#bbb></span>}<span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#080;font-weight:700>fn</span> <span style=color:#06b;font-weight:700>main</span><span style=color:#bbb> </span>()<span style=color:#bbb>
</span><span style=color:#bbb></span>{<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-weight:700>let</span><span style=color:#bbb> </span>big_string: <span style=color:#007020>String</span> <span style=color:#333>=</span><span style=color:#bbb> </span><span style=background-color:#fff0f0>&#34;SPAM&#34;</span>.repeat(<span style=color:#00d;font-weight:700>1_000</span>);<span style=color:#bbb>
</span><span style=color:#bbb>    </span>scope(<span style=color:#333>|</span>scope<span style=color:#333>|</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:#080;font-weight:700>let</span><span style=color:#bbb> </span>ref_1: <span style=color:#038;font-weight:700>&amp;</span><span style=color:#888>/*shared*/</span><span style=color:#bbb> </span><span style=color:#007020>String</span><span style=color:#bbb> </span><span style=color:#333>=</span><span style=color:#bbb> </span><span style=color:#333>&amp;</span>big_string;<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:#080;font-weight:700>let</span><span style=color:#bbb> </span>ref_2: <span style=color:#038;font-weight:700>&amp;</span><span style=color:#888>/*shared*/</span><span style=color:#bbb> </span><span style=color:#007020>String</span><span style=color:#bbb> </span><span style=color:#333>=</span><span style=color:#bbb> </span><span style=color:#333>&amp;</span>big_string;<span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:#888>// Thread1
</span><span style=color:#888></span><span style=color:#bbb>        </span>scope.spawn(<span style=color:#080;font-weight:700>move</span><span style=color:#bbb> </span><span style=color:#888>/* ref_1 */</span><span style=color:#bbb> </span><span style=color:#333>|</span>_<span style=color:#333>|</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:#080;font-weight:700>let</span><span style=color:#bbb> </span>thread_id<span style=color:#bbb> </span><span style=color:#333>=</span><span style=color:#bbb> </span>thread::current().id();<span style=color:#bbb>
</span><span style=color:#bbb>            </span>slow_repeat(<span style=color:#00d;font-weight:700>10</span>,<span style=color:#bbb> </span><span style=color:#333>||</span><span style=color:#bbb> </span>println<span style=color:#333>!</span>(<span style=background-color:#fff0f0>&#34;[{:?}] {}&#34;</span>,<span style=color:#bbb>
</span><span style=color:#bbb>                </span>thread_id,<span style=color:#bbb>
</span><span style=color:#bbb>                </span><span style=color:#333>*</span>ref_1,<span style=color:#bbb> </span><span style=color:#888>// read the string data
</span><span style=color:#888></span><span style=color:#bbb>            </span>));<span style=color:#bbb>
</span><span style=color:#bbb>        </span>});<span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:#888>// Thread2
</span><span style=color:#888></span><span style=color:#bbb>        </span>scope.spawn(<span style=color:#080;font-weight:700>move</span><span style=color:#bbb> </span><span style=color:#888>/* ref_2 */</span><span style=color:#bbb> </span><span style=color:#333>|</span>_<span style=color:#333>|</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:#080;font-weight:700>let</span><span style=color:#bbb> </span>thread_id<span style=color:#bbb> </span><span style=color:#333>=</span><span style=color:#bbb> </span>thread::current().id();<span style=color:#bbb>
</span><span style=color:#bbb>            </span>slow_repeat(<span style=color:#00d;font-weight:700>10</span>,<span style=color:#bbb> </span><span style=color:#333>||</span><span style=color:#bbb> </span>println<span style=color:#333>!</span>(<span style=background-color:#fff0f0>&#34;[{:?}] {}&#34;</span>,<span style=color:#bbb>
</span><span style=color:#bbb>                </span>thread_id,<span style=color:#bbb>
</span><span style=color:#bbb>                </span><span style=color:#333>*</span>ref_2,<span style=color:#bbb> </span><span style=color:#888>// read the string data
</span><span style=color:#888></span><span style=color:#bbb>            </span>));<span style=color:#bbb>
</span><span style=color:#bbb>        </span>});<span style=color:#bbb>
</span><span style=color:#bbb>    </span>})<span style=color:#bbb>  </span><span style=color:#888>// automagically joins all the scoped threads
</span><span style=color:#888></span><span style=color:#bbb>        </span>.expect(<span style=background-color:#fff0f0>&#34;Some thread panicked&#34;</span>);<span style=color:#bbb>
</span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></code></pre></div></li></ul><h3 id=safe-abstractions-built-on-top-of-unsafecell>Safe abstractions built on top of <code>UnsafeCell</code></h3><table><thead><tr><th align=center></th><th align=center><code>!Sync</code></th><th align=center><code>Sync</code></th></tr></thead><tbody><tr><td align=center><code>T</code></td><td align=center><code>RefCell&lt;T&gt;</code></td><td align=center><code>RwLock&lt;T&gt;</code> (and <code>Mutex&lt;T&gt;</code>)</td></tr><tr><td align=center>integer</td><td align=center><code>Cell&lt;usize&gt;</code> / <code>Cell&lt;isize&gt;</code></td><td align=center><code>AtomicUsize</code> / <code>AtomicIsize</code></td></tr><tr><td align=center><code>T : Copy</code></td><td align=center><code>Cell&lt;T&gt;</code></td><td align=center>NO</td></tr><tr><td align=center>pointer</td><td align=center><code>Cell&lt;*mut T&gt;</code></td><td align=center><code>AtomicPtr</code></td></tr></tbody></table><h1 id=tbd>TBD</h1><div class=footnotes><hr><ol><li id=fn:2>except for the fact that a <code>static</code> can be limited to private scopes, such as when defined within a function&rsquo;s body, or when defined within a <code>mod</code> with a non-<code>pub</code> path leading to it
<a class=footnote-return href=#fnref:2><sup>[return]</sup></a></li></ol></div></div><div class=prev-next><a class="prev-next-link prev-link" href=/posts/2019-02-24-mutation-part-2-to-mut-or-not-to-mut/><button class="button prev-button">
<span>Prev post</span></button></a></div></main></body></html>