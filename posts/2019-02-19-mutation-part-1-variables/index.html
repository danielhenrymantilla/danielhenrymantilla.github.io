<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><link href=//gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.54.0"><meta name=viewport content="width=device-width,initial-scale=1"><title>Mutation - Part 1: Variables &middot; Another one bytes the Rust!</title><link type=text/css rel=stylesheet href=https://danielhenrymantilla.github.io/css/prev-next_buttons.css><link type=text/css rel=stylesheet href=https://danielhenrymantilla.github.io/css/inline_svgs.css><link type=text/css rel=stylesheet href=https://danielhenrymantilla.github.io/css/print.css media=print><link type=text/css rel=stylesheet href=https://danielhenrymantilla.github.io/css/poole.css><link type=text/css rel=stylesheet href=https://danielhenrymantilla.github.io/css/syntax.css><link type=text/css rel=stylesheet href=https://danielhenrymantilla.github.io/css/hyde.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png><link href rel=alternate type=application/rss+xml title="Another one bytes the Rust!"></head><body class="theme-base-08 layout-reverse"><aside class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://danielhenrymantilla.github.io/><h1>Another one bytes the Rust!</h1></a><p class=lead>Thoughts and ramblings for the like-minded</p></div><nav><ul class=sidebar-nav><li><a href=https://danielhenrymantilla.github.io/>Home</a></li><li><a href=/series>Blog Post Series</a></li><li><a href=/categories>Categories</a></li><li><a href=/tags>Tags</a></li></ul></nav><p>&copy; 2019. All rights reserved.</p></div></aside><main class="content container"><div class=prev-next><a class="prev-next-link prev-link" href=/posts/2019-02-19-mutation-part-0-intro/><button class="button prev-button">
<span>Prev post</span></button></a>
<a class="prev-next-link next-link" href=/posts/2019-02-24-mutation-part-2-to-mut-or-not-to-mut/><button class="button next-button">
<span>Next post</span></button></a></div><div class=post><h1>Mutation - Part 1: Variables</h1><time datetime=2019-02-17T15:07:48&#43;0100 class=post-date>Sun, Feb 17, 2019</time><h1 id=what-is-a-variable>What is a variable?</h1><p>Ok, here there is really a lot that could be said, and a simple blog post will not cover it. I will just talk about <strong>two important and distinct thinking patterns</strong> involved:</p><ol><li><p>the idea of <em>binding a name to a value</em>;</p></li><li><p>the idea of reading/writing values from/into memory;</p></li></ol><h2 id=1-identity-binding>1. Identity binding</h2><p>The best example in Rust for &ldquo;just a binding&rdquo; (<em>i.e.</em>, with <strong>no backing memory</strong>) is <code>const</code></p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span style=color:#080;font-weight:700>type</span> <span style=color:#b06;font-weight:700>is</span><span style=color:#bbb> </span><span style=color:#333>=</span><span style=color:#bbb> </span><span style=color:#339;font-weight:700>i32</span>;<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span style=color:#bbb>
</span><span style=display:block;width:100%;background-color:#e5e5e5><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span style=color:#bbb></span><span style=color:#080;font-weight:700>const</span><span style=color:#bbb> </span>x<span style=color:#bbb>          </span>:<span style=color:#b06;font-weight:700>is</span><span style=color:#333>=</span><span style=color:#bbb> </span>the_answer<span style=color:#bbb> </span><span style=color:#333>+</span><span style=color:#bbb> </span><span style=color:#00d;font-weight:700>27</span>;<span style=color:#bbb>
</span></span><span style=display:block;width:100%;background-color:#e5e5e5><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span style=color:#bbb></span><span style=color:#080;font-weight:700>const</span><span style=color:#bbb> </span>the_answer<span style=color:#bbb> </span>:<span style=color:#b06;font-weight:700>is</span><span style=color:#333>=</span><span style=color:#bbb> </span><span style=color:#00d;font-weight:700>42</span>;<span style=color:#bbb>
</span></span></code></pre></div><p>Here we have defined <code>the_answer</code> as an <em>alias</em> for the value <code>42</code>; meaning that, from now on, everytime we say <code>the_answer</code> what we actually mean is <code>42</code>.</p><p>We are at the <a href=/tags/meta-programming>meta</a> level: if we ask the program to evaluate <code>x</code>, what we are actually<sup class=footnote-ref id=fnref:1><a href=#fn:1>1</a></sup> asking the program to do is to evaluate <code>the_answer + 27</code>, <em>i.e.</em>, to evaluate <code>42 + 27</code>.</p><p>The same in C, with <code>#define</code>:<div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:block;width:100%;background-color:#e5e5e5><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span style=color:#579>#define x          (the_answer + 27)
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span style=color:#579></span>
<span style=display:block;width:100%;background-color:#e5e5e5><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span style=color:#579>#define the_answer (42)</span></span></code></pre></div></p><p>If you look at both code snippets, you can notice that there is no notion of temporality (regarding the definitions):</p><blockquote><p>It is all about <em>essence</em> / <em>identity</em>.</p></blockquote><p>Thus, if <code>the_answer</code> <em>is</em> and <em>will always be</em> <code>42</code>, <strong>there is no room for <em>mutation</em></strong>.</p><ul><li><p><code>42</code> cannot mutate and become <code>43</code>; <code>42</code> is and will always be
<code>1 + 1 + 1 + 1 + 1 + 1 + 1 + 1 + 1 + 1 + 1 + 1 + 1 + 1 + 1 + 1 + 1 + 1 + 1 + 1 + 1 + 1 + 1 + 1 + 1 + 1 + 1 + 1 + 1 + 1 + 1 + 1 + 1 + 1 + 1 + 1 + 1 + 1 + 1 + 1 + 1 + 1 + 0</code><sup class=footnote-ref id=fnref:2><a href=#fn:2>2</a></sup></p></li><li><p>in a similar manner, <code>the_answer</code> cannot change either, since it was defined as <strong>being</strong> 42: it is an identity, and&hellip;</p><p><img src=https://i.imgflip.com/2tx145.jpg alt="One does not simply change an identity"></p></li><li><p>and yet &hellip; we feel like we should be able to redefine what <code>the_answer</code> is, don&rsquo;t we?</p><blockquote><p><strong>re-define</strong>?</p></blockquote><ul><li><p>This implies some form of temporality, and for that there are two solutions:</p><ol><li><p>scoped bindings (and shadowing).</p></li><li><p>a binding to (runtime) memory.</p></li></ol></li></ul></li></ul><h3 id=1-1-scoped-bindings>1.1 Scoped bindings</h3><p>You can limit the &ldquo;scope&rdquo; of your identity-definition:<div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span style=color:#888>// undefined
</span><span style=display:block;width:100%;background-color:#e5e5e5><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span style=color:#888></span>{<span style=color:#080;font-weight:700>const</span><span style=color:#bbb> </span>the_answer<span style=color:#bbb> </span>:<span style=color:#b06;font-weight:700>is</span><span style=color:#333>=</span><span style=color:#bbb> </span><span style=color:#00d;font-weight:700>42</span>;<span style=color:#bbb>
</span></span><span style=display:block;width:100%;background-color:#e5e5e5><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span style=color:#bbb>    </span><span style=color:#888>// defined
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span style=color:#888></span>}<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span style=color:#bbb></span><span style=color:#888>// undefined
</span></code></pre></div></p><p>This is one of the ways to have some form of temporality with bindings: time progresses as we enter and leave scopes.<div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span>{<span style=color:#080;font-weight:700>const</span><span style=color:#bbb> </span>the_answer<span style=color:#bbb> </span>:<span style=color:#b06;font-weight:700>is</span><span style=color:#333>=</span><span style=color:#bbb> </span><span style=color:#00d;font-weight:700>42</span>;<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span style=color:#bbb>    </span>{<span style=color:#080;font-weight:700>const</span><span style=color:#bbb> </span>x<span style=color:#bbb> </span>:<span style=color:#b06;font-weight:700>is</span><span style=color:#333>=</span><span style=color:#bbb> </span>the_answer<span style=color:#bbb> </span><span style=color:#333>+</span><span style=color:#bbb> </span><span style=color:#00d;font-weight:700>27</span>;<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span style=color:#bbb>        </span><span style=color:#888>// x -&gt; the_answer + 27 -&gt; 42 + 27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span style=color:#888></span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></code></pre></div></p><blockquote><p>But what about <strong>re-defining</strong> <code>the_answer</code>?</p></blockquote><p>By using a narrower scope, we can indeed <em>re-define</em> the value of <code>the_answer</code>, even though what we are actually doing is defining a brand new <code>the_answer</code> that happens to lead to a name collision. But given the different scopes and their temporality, this is unambiguous and thus allowed:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span>{<span style=color:#080;font-weight:700>const</span><span style=color:#bbb> </span>the_answer<span style=color:#bbb> </span>:<span style=color:#b06;font-weight:700>is</span><span style=color:#333>=</span><span style=color:#bbb> </span><span style=color:#00d;font-weight:700>42</span>;<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span style=color:#bbb>    </span><span style=color:#888>// &#39;the_answer&#39; &lt;-&gt; 42
</span><span style=display:block;width:100%;background-color:#e5e5e5><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span style=color:#888></span><span style=color:#bbb>    </span>{<span style=color:#080;font-weight:700>const</span><span style=color:#bbb> </span>the_answer<span style=color:#bbb> </span>:<span style=color:#b06;font-weight:700>is</span><span style=color:#333>=</span><span style=color:#bbb> </span><span style=color:#00d;font-weight:700>0</span>;<span style=color:#bbb>
</span></span><span style=display:block;width:100%;background-color:#e5e5e5><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span style=color:#bbb>        </span><span style=color:#888>// &#39;the_answer&#39; &lt;-&gt; 0
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span style=color:#888></span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span style=color:#bbb>    </span><span style=color:#888>// &#39;the_answer&#39; &lt;-&gt; 42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span style=color:#888></span>}<span style=color:#bbb>
</span></code></pre></div><p>This trick is called <strong>shadowing</strong> and is a clever way to avoid using mutation when it is not needed.</p><h2 id=2-runtime-memory>2. Runtime memory</h2><p>We are so used to manipulating memory through variables that I have defined some functions to pretend we are manipulating low-level memory; it thus provides &ldquo;primitives / intrinsics&rdquo; that allow us to read/write from/into the memory and also to print values:</p><a class=inline-svg href="https://play.rust-lang.org/?&code=%23%21%5ballow%28non_camel_case_types%2c%20non_snake_case%29%5d%0a%0a%2f%2f%2f%204Ko%20RAM%3f%0astatic%20mut%20MEMORY%3a%20%5bu8%3b%204096%5d%20%3d%20%5b0%3b%204096%5d%3b%0atype%20address%20%3d%20usize%3b%0a%0afn%20READ%20%28whence%3a%20address%29%20-%3e%20u8%0a%7b%0a%20%20%20%20unsafe%20%7b%20MEMORY%5bwhence%5d%20%7d%0a%7d%0a%0afn%20WRITE%20%28where_to%3a%20address%2c%20what%3a%20u8%29%0a%7b%0a%20%20%20%20unsafe%20%7b%20MEMORY%5bwhere_to%5d%20%3d%20what%20%7d%0a%7d%0a%0ause%20%3a%3astd%3a%3adbg%20as%20PRINT%3b%0a%0afn%20main%20%28%29%0a%7b%0a%20%20%20%20WRITE%281000%2c%2042%29%3b%0a%20%20%20%20WRITE%281001%2c%2027%29%3b%0a%20%20%20%20PRINT%21%28READ%281000%29%29%3b%20%2f%2f%20-%3e%2042%0a%20%20%20%20WRITE%281000%2c%20READ%281000%29%20%2b%20READ%281001%29%29%3b%0a%20%20%20%20PRINT%21%28READ%281000%29%29%3b%20%2f%2f%20-%3e%2069%0a%7d%0a" target=_blank><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="#606060" d="M424.4 214.7 72.4 6.6C43.8-10.3.0 6.1.0 47.9V464c0 37.5 40.7 60.1 72.4 41.3l352-208c31.4-18.5 31.5-64.1.0-82.6z"/></svg></a><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Rust data-lang=Rust><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span style=color:#579>#![allow(non_camel_case_types, non_snake_case)]</span><span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span style=color:#bbb></span><span style=color:#d42;background-color:#fff0f0>/// 4Ko RAM?
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span style=color:#d42;background-color:#fff0f0></span><span style=color:#080;font-weight:700>static</span><span style=color:#bbb> </span><span style=color:#080;font-weight:700>mut</span><span style=color:#bbb> </span>MEMORY: [<span style=color:#339;font-weight:700>u8</span>;<span style=color:#bbb> </span><span style=color:#00d;font-weight:700>4096</span>]<span style=color:#bbb> </span><span style=color:#333>=</span><span style=color:#bbb> </span>[<span style=color:#00d;font-weight:700>0</span>;<span style=color:#bbb> </span><span style=color:#00d;font-weight:700>4096</span>];<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span style=color:#bbb></span><span style=color:#080;font-weight:700>type</span> <span style=color:#b06;font-weight:700>address</span><span style=color:#bbb> </span><span style=color:#333>=</span><span style=color:#bbb> </span><span style=color:#339;font-weight:700>usize</span>;<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span style=color:#bbb></span><span style=color:#080;font-weight:700>fn</span> <span style=color:#06b;font-weight:700>READ</span><span style=color:#bbb> </span>(whence: <span style=color:#b06;font-weight:700>address</span>)<span style=color:#bbb> </span>-&gt; <span style=color:#339;font-weight:700>u8</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span>{<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span style=color:#bbb>    </span><span style=color:#080;font-weight:700>unsafe</span><span style=color:#bbb> </span>{<span style=color:#bbb> </span>MEMORY[whence]<span style=color:#bbb> </span>}<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span style=color:#bbb></span>}<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span style=color:#bbb></span><span style=color:#080;font-weight:700>fn</span> <span style=color:#06b;font-weight:700>WRITE</span><span style=color:#bbb> </span>(where_to: <span style=color:#b06;font-weight:700>address</span>,<span style=color:#bbb> </span>what: <span style=color:#339;font-weight:700>u8</span>)<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span style=color:#bbb></span>{<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span style=color:#bbb>    </span><span style=color:#080;font-weight:700>unsafe</span><span style=color:#bbb> </span>{<span style=color:#bbb> </span>MEMORY[where_to]<span style=color:#bbb> </span><span style=color:#333>=</span><span style=color:#bbb> </span>what<span style=color:#bbb> </span>}<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span style=color:#bbb></span>}<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span style=color:#bbb></span><span style=color:#080;font-weight:700>use</span><span style=color:#bbb> </span>::std::dbg<span style=color:#bbb> </span><span style=color:#080;font-weight:700>as</span><span style=color:#bbb> </span>PRINT;<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span style=color:#bbb></span><span style=color:#080;font-weight:700>fn</span> <span style=color:#06b;font-weight:700>main</span><span style=color:#bbb> </span>()<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span style=color:#bbb></span>{<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span style=color:#bbb>    </span>WRITE(<span style=color:#00d;font-weight:700>1000</span>,<span style=color:#bbb> </span><span style=color:#00d;font-weight:700>42</span>);<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span style=color:#bbb>    </span>WRITE(<span style=color:#00d;font-weight:700>1001</span>,<span style=color:#bbb> </span><span style=color:#00d;font-weight:700>27</span>);<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span style=color:#bbb>    </span>PRINT<span style=color:#333>!</span>(READ(<span style=color:#00d;font-weight:700>1000</span>));<span style=color:#bbb> </span><span style=color:#888>// -&gt; 42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span style=color:#888></span><span style=color:#bbb>    </span>WRITE(<span style=color:#00d;font-weight:700>1000</span>,<span style=color:#bbb> </span>READ(<span style=color:#00d;font-weight:700>1000</span>)<span style=color:#bbb> </span><span style=color:#333>+</span><span style=color:#bbb> </span>READ(<span style=color:#00d;font-weight:700>1001</span>));<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span style=color:#bbb>    </span>PRINT<span style=color:#333>!</span>(READ(<span style=color:#00d;font-weight:700>1000</span>));<span style=color:#bbb> </span><span style=color:#888>// -&gt; 69
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span style=color:#888></span>}<span style=color:#bbb>
</span></code></pre></div><p>This way, we can see that we were able to</p><ol><li><p>write at the address <code>1000</code> the value <code>42</code>;</p></li><li><p>then write at that same address the value <code>69</code>.</p></li></ol><p><strong>We have successfully mutated something!</strong></p><p>Good, now we have a clearer understanding of what <em>mutation</em> actually is:
modifying <strong>memory contents</strong>.</p><p>But what have variables to do with any of this?</p><h3 id=2-1-runtime-memory-with-variables>2.1 Runtime memory with variables</h3><p>The following sentence explains the relation between bindings and memory:</p><blockquote><p>A (runtime) variable is a (static) binding to some place in memory, and is used to read/write from/into that place in memory</p></blockquote><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Rust data-lang=Rust><span style=color:#080;font-weight:700>const</span><span style=color:#bbb> </span>at_the_answer: <span style=color:#b06;font-weight:700>address</span><span style=color:#bbb> </span><span style=color:#333>=</span><span style=color:#bbb> </span><span style=color:#00d;font-weight:700>1000</span>;<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#080;font-weight:700>const</span><span style=color:#bbb> </span>at_x: <span style=color:#b06;font-weight:700>address</span><span style=color:#bbb> </span><span style=color:#333>=</span><span style=color:#bbb> </span><span style=color:#00d;font-weight:700>1001</span>;<span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#080;font-weight:700>fn</span> <span style=color:#06b;font-weight:700>main</span><span style=color:#bbb> </span>()<span style=color:#bbb>
</span><span style=color:#bbb></span>{<span style=color:#bbb>
</span><span style=color:#bbb>    </span>WRITE(at_the_answer,<span style=color:#bbb> </span><span style=color:#00d;font-weight:700>42</span>);<span style=color:#bbb>
</span><span style=color:#bbb>    </span>WRITE(at_x,<span style=color:#bbb> </span><span style=color:#00d;font-weight:700>27</span>);<span style=color:#bbb>
</span><span style=color:#bbb>    </span>PRINT(READ(at_the_answer));<span style=color:#bbb> </span><span style=color:#888>// -&gt; 42
</span><span style=color:#888></span><span style=color:#bbb>    </span>WRITE(at_the_answer,<span style=color:#bbb> </span>READ(at_the_answer)<span style=color:#bbb> </span><span style=color:#333>+</span><span style=color:#bbb> </span>READ(at_x));<span style=color:#bbb>
</span><span style=color:#bbb>    </span>PRINT<span style=color:#333>!</span>(READ(at_the_answer));<span style=color:#bbb> </span><span style=color:#888>// -&gt; 69
</span><span style=color:#888></span>}<span style=color:#bbb>
</span></code></pre></div><p>And now with some sugar:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Rust data-lang=Rust><span style=color:#080;font-weight:700>const</span><span style=color:#bbb> </span>at_the_answer: <span style=color:#b06;font-weight:700>address</span><span style=color:#bbb> </span><span style=color:#333>=</span><span style=color:#bbb> </span><span style=color:#00d;font-weight:700>1000</span>;<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#080;font-weight:700>const</span><span style=color:#bbb> </span>at_x: <span style=color:#b06;font-weight:700>address</span><span style=color:#bbb> </span><span style=color:#333>=</span><span style=color:#bbb> </span><span style=color:#00d;font-weight:700>1001</span>;<span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb></span>main<span style=color:#333>!</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span><span style=color:#bbb>    </span>the_answer<span style=color:#bbb> </span><span style=color:#333>&lt;-</span><span style=color:#bbb> </span><span style=color:#00d;font-weight:700>42</span>;<span style=color:#bbb>
</span><span style=color:#bbb>    </span>x<span style=color:#bbb> </span><span style=color:#333>&lt;-</span><span style=color:#bbb> </span><span style=color:#00d;font-weight:700>27</span>;<span style=color:#bbb>
</span><span style=color:#bbb>    </span>PRINT<span style=color:#333>!</span>(the_answer);<span style=color:#bbb> </span><span style=color:#888>// -&gt; 42
</span><span style=display:block;width:100%;background-color:#e5e5e5><span style=color:#888></span><span style=color:#bbb>    </span>the_answer<span style=color:#bbb> </span><span style=color:#333>&lt;-</span><span style=color:#bbb> </span>the_answer<span style=color:#bbb> </span><span style=color:#333>+</span><span style=color:#bbb> </span>x;<span style=color:#bbb>
</span></span><span style=color:#bbb>    </span>PRINT<span style=color:#333>!</span>(the_answer);<span style=color:#bbb> </span><span style=color:#888>// -&gt; 69
</span><span style=color:#888></span>}<span style=color:#bbb>
</span></code></pre></div><p>How does that sugar work? Let&rsquo;s describe the unsugaring of line <code>139</code>:</p><ul><li><p>The statement <code>the_answer &lt;- the_answer + x;</code> is identified as an <strong>assignment</strong>:
a value (right hand side) is written to memory (left hand side)</p><ol><li><p>First the right hand side of the assignment (<code>the_answer + x</code>) is treated,
and every variable occurrence is replaced with <strong>READ</strong> memory access:</p><ul><li><p><code>the_answer</code> becomes <code>READ(at_the_answer)</code></p></li><li><p><code>x</code> becomes <code>READ!(at_x)</code></p></li></ul></li><li><p>Then the left hand side of the assignment (<code>the_answer</code>) is treated,
and the variable is replaced with a <strong>WRITE</strong> memory access:</p><ul><li><code>the_answer &lt;- ...</code> becomes <code>WRITE(at_the_answer, ...)</code></li></ul></li></ol></li><li><p>We end up with the following unsugaring:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Rust data-lang=Rust>WRITE(at_the_answer,<span style=color:#bbb> </span>READ(at_the_answer)<span style=color:#bbb> </span><span style=color:#333>+</span><span style=color:#bbb> </span>READ(at_x));<span style=color:#bbb>
</span></code></pre></div></li></ul><p>Hence my aforementioned definition of a variable (let&rsquo;s repeat it):</p><blockquote><p>A (runtime) variable is a (static) binding to some place in memory, and is <em>used</em> to read/write from/into that place in memory</p></blockquote><p>In memory? But where exactly?</p><h2 id=static-vs-let><code>static</code> vs <code>let</code></h2><p>In Rust, there are two<sup class=footnote-ref id=fnref:3><a href=#fn:3>3</a></sup> ways to declare a variable:</p><ul><li><p><strong><code>static</code></strong>, for <strong>global</strong> variables;
the variable refers to a section of memory statically laid out before the program runs, and which is never deallocated.</p><p>There often are two such sections:</p><ul><li><p>The <code>.rodata</code> section, which is <strong>read-only</strong>.
Attempting to write in this section will result in a memory violation,
<em>a.k.a.</em> a <em>Segmentation Fault</em>.</p></li><li><p>The <code>.data</code> section<sup class=footnote-ref id=fnref:4><a href=#fn:4>4</a></sup>, which is both <strong>readable and writable</strong>.</p></li></ul></li><li><p><strong><code>let</code></strong><sup class=footnote-ref id=fnref:5><a href=#fn:5>5</a></sup>, for <strong>local</strong> variables: the variable refers to a section of memory called <strong>the stack</strong>. It is always <strong>readable and writable</strong>.</p><p>Clever pointer arithmetic using two<sup class=footnote-ref id=fnref:6><a href=#fn:6>6</a></sup> CPU registers leads to a very useful abstraction:
<strong>stack frames</strong>, which can be created and accumulated on top of each other using LIFO semantics (hence the name of the section).</p><p>They thus become very well suited for scoped memory, such as function locals:</p><ol><li><p>When a scope starts, the compiler looks at all the local variables declared within that scope (<em>e.g.</em>, <code>x: i32</code> and <code>y: u8</code> within <code>foo</code>&rsquo;s function);</p></li><li><p>Then a new stack frame is created by shifting the stack pointer(s), in order to reserve enough memory for all those variables (<em>e.g.</em>, <code>4 + 1 = 5</code> bytes are allocated in <code>foo</code>&rsquo;s stack frame);</p></li><li><p>Within that function&rsquo;s body, each &ldquo;variable&rdquo; is just a statically known offset from the beginning of the stack frame (<em>e.g.</em>, <code>at_x</code> and <code>at_y</code> are the offsets <code>0</code> and <code>4</code> from the beginning<sup class=footnote-ref id=fnref:7><a href=#fn:7>7</a></sup> of the stack frame). And as said previously, each &ldquo;variable access&rdquo; is actually the result of dereferencing<sup class=footnote-ref id=fnref:8><a href=#fn:8>8</a></sup> those offsets, each time;</p></li><li><p>When the scope ends, the frame is automatically and inevitably <code>pop</code>-ped off, <em>i.e.</em>, <strong>freed</strong>.</p></li></ol></li></ul><blockquote><p>We finally have the bases required for thinking about mutation in Rust!</p></blockquote><h2 id=appendix>Appendix</h2><h4 id=full-unsugaring-code>Full unsugaring code</h4><a class=inline-svg href="https://play.rust-lang.org/?&code=%23%21%5ballow%28non_upper_case_globals%2c%20non_snake_case%29%5d%0a%0a%2f%2f%2f%204Ko%20RAM%3f%0astatic%20mut%20MEMORY%3a%20%5bu8%3b%204096%5d%20%3d%20%5b0%3b%204096%5d%3b%0a%0afn%20READ%20%28whence%3a%20address%29%20-%3e%20u8%0a%7b%0a%20%20%20%20unsafe%20%7b%20MEMORY%5bwhence%5d%20%7d%0a%7d%0a%0afn%20WRITE%20%28where_to%3a%20address%2c%20what%3a%20u8%29%0a%7b%0a%20%20%20%20unsafe%20%7b%20MEMORY%5bwhere_to%5d%20%3d%20what%20%7d%0a%7d%0a%0a%2f%2f%2f%20Recursively%20replaces%3a%0a%2f%2f%2f%20%20%20%20%20the_answer%20%3d%3e%20READ%28at_the_answer%29%0a%2f%2f%2f%20%20%20%20%20x%20%20%20%20%20%20%20%20%20%20%3d%3e%20READ%28at_x%29%0amacro_rules%21%20replace_rvalues%20%7b%0a%20%20%20%20%28%0a%20%20%20%20%20%20%20%20%5b%20%24%28%24replaced%3att%29%2a%20%5d%0a%20%20%20%20%20%20%20%20the_answer%0a%20%20%20%20%20%20%20%20%24%28%24rest%3att%29%2a%0a%20%20%20%20%29%20%3d%3e%20%28replace_rvalues%21%28%0a%20%20%20%20%20%20%20%20%5b%20%24%28%24replaced%29%2a%20READ%28at_the_answer%29%20%5d%0a%20%20%20%20%20%20%20%20%24%28%24rest%29%2a%0a%20%20%20%20%29%29%3b%0a%0a%20%20%20%20%28%0a%20%20%20%20%20%20%20%20%5b%20%24%28%24replaced%3att%29%2a%20%5d%0a%20%20%20%20%20%20%20%20x%0a%20%20%20%20%20%20%20%20%24%28%24rest%3att%29%2a%0a%20%20%20%20%29%20%3d%3e%20%28replace_rvalues%21%28%0a%20%20%20%20%20%20%20%20%5b%20%24%28%24replaced%29%2a%20READ%28at_x%29%20%5d%0a%20%20%20%20%20%20%20%20%24%28%24rest%29%2a%0a%20%20%20%20%29%29%3b%0a%0a%0a%20%20%20%20%28%0a%20%20%20%20%20%20%20%20%5b%20%24%28%24replaced%3att%29%2a%20%5d%0a%20%20%20%20%20%20%20%20%24tt%3att%0a%20%20%20%20%20%20%20%20%24%28%24rest%3att%29%2a%0a%20%20%20%20%29%20%3d%3e%20%28replace_rvalues%21%28%0a%20%20%20%20%20%20%20%20%5b%20%24%28%24replaced%29%2a%20%24tt%20%5d%0a%20%20%20%20%20%20%20%20%24%28%24rest%29%2a%0a%20%20%20%20%29%29%3b%0a%0a%20%20%20%20%28%0a%20%20%20%20%20%20%20%20%5b%20%24%28%24replaced%3att%29%2a%20%5d%0a%20%20%20%20%29%20%3d%3e%20%28%0a%20%20%20%20%20%20%20%20%24%28%24replaced%29%2a%0a%20%20%20%20%29%3b%0a%0a%20%20%20%20%28%20%24%28%24tt%3att%29%2a%20%29%20%3d%3e%20%28%0a%20%20%20%20%20%20%20%20replace_rvalues%21%28%5b%5d%20%24%28%24tt%29%2a%29%0a%20%20%20%20%29%0a%7d%0a%0amacro_rules%21%20exec%20%7b%0a%20%20%20%20%2f%2a%20replaces%20%2a%2f%20%28%0a%20%20%20%20%20%20%20%20the_answer%20%3c-%20%24%28%24tt%3att%29%2a%0a%20%20%20%20%29%20%3d%3e%20%2f%2a%20with%20%2a%2f%20%28%0a%20%20%20%20%20%20%20%20WRITE%28at_the_answer%2c%0a%20%20%20%20%20%20%20%20%20%20%20%20replace_rvalues%21%28%20%24%28%24tt%29%2a%20%29%0a%20%20%20%20%20%20%20%20%29%0a%20%20%20%20%29%3b%0a%0a%20%20%20%20%2f%2a%20replaces%20%2a%2f%20%28%0a%20%20%20%20%20%20%20%20x%20%3c-%20%24%28%24tt%3att%29%2a%0a%20%20%20%20%29%20%3d%3e%20%2f%2a%20WITH%20%2a%2f%20%28%0a%20%20%20%20%20%20%20%20WRITE%28at_x%2c%0a%20%20%20%20%20%20%20%20%20%20%20%20replace_rvalues%21%28%20%24%28%24tt%29%2a%20%29%0a%20%20%20%20%20%20%20%20%29%0a%20%20%20%20%29%3b%0a%0a%20%20%20%20%2f%2a%20replaces%20%2a%2f%20%28%0a%20%20%20%20%20%20%20%20PRINT%20%28%20%24%28%24tt%3att%29%2a%20%29%0a%20%20%20%20%29%20%3d%3e%20%2f%2a%20with%20%2a%2f%20%28%0a%20%20%20%20%20%20%20%20println%21%28%22%7b%7d%20%3d%20%7b%7d%22%2c%20stringify%21%28%24%28%24tt%29%2a%29%2c%20replace_rvalues%21%28%20%24%28%24tt%29%2a%20%29%29%3b%0a%20%20%20%20%29%3b%0a%7d%0a%0amacro_rules%21%20main%20%7b%0a%20%20%20%20%28%40parsing%0a%20%20%20%20%20%20%20%20%5b%20%24%28%24stmts%3att%29%2a%20%5d%0a%20%20%20%20%20%20%20%20%5b%20%24%28%24current%3att%29%2a%20%5d%0a%20%20%20%20%20%20%20%20%3b%0a%20%20%20%20%20%20%20%20%24%28%24rest%3att%29%2a%0a%20%20%20%20%29%20%3d%3e%20%28main%21%7b%40parsing%0a%20%20%20%20%20%20%20%20%5b%20%24%28%24stmts%29%2a%20%28%20%24%28%24current%29%2a%20%29%20%5d%0a%20%20%20%20%20%20%20%20%5b%5d%0a%20%20%20%20%20%20%20%20%24%28%24rest%29%2a%0a%20%20%20%20%7d%29%3b%0a%0a%20%20%20%20%28%40parsing%0a%20%20%20%20%20%20%20%20%24stmts%3att%0a%20%20%20%20%20%20%20%20%5b%20%24%28%24current%3att%29%2a%20%5d%0a%20%20%20%20%20%20%20%20%24tt%3att%20%24%28%24rest%3att%29%2a%0a%20%20%20%20%29%20%3d%3e%20%28main%21%7b%40parsing%0a%20%20%20%20%20%20%20%20%24stmts%0a%20%20%20%20%20%20%20%20%5b%20%24%28%24current%29%2a%20%24tt%5d%0a%20%20%20%20%20%20%20%20%24%28%24rest%29%2a%0a%20%20%20%20%7d%29%3b%0a%0a%20%20%20%20%28%40parsing%0a%20%20%20%20%20%20%20%20%5b%20%24%28%20%28%20%24%28%24stmts%3att%29%2a%20%29%20%29%2a%20%5d%0a%20%20%20%20%20%20%20%20%5b%5d%0a%20%20%20%20%29%20%3d%3e%20%28%0a%20%20%20%20%20%20%20%20fn%20main%20%28%29%20%7b%0a%20%20%20%20%20%20%20%20%20%20%20%20%24%28%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20exec%21%7b%20%24%28%24stmts%29%2a%20%7d%0a%20%20%20%20%20%20%20%20%20%20%20%20%29%2a%0a%20%20%20%20%20%20%20%20%7d%0a%20%20%20%20%29%3b%0a%0a%20%20%20%20%28%0a%20%20%20%20%20%20%20%20%24%28%24tt%3att%29%2a%0a%20%20%20%20%29%20%3d%3e%20%28main%21%7b%40parsing%0a%20%20%20%20%20%20%20%20%5b%5d%0a%20%20%20%20%20%20%20%20%5b%5d%0a%20%20%20%20%20%20%20%20%24%28%24tt%29%2a%0a%20%20%20%20%7d%29%3b%0a%7d%0a%0a%23%5ballow%28non_camel_case_types%29%5d%0atype%20address%20%3d%20usize%3b%0a%0aconst%20at_the_answer%3a%20address%20%3d%201000%3b%0aconst%20at_x%3a%20address%20%3d%201001%3b%0a%0amain%21%20%7b%0a%20%20%20%20the_answer%20%3c-%2042%3b%0a%20%20%20%20x%20%3c-%2027%3b%0a%20%20%20%20PRINT%28the_answer%29%3b%20%2f%2f%20-%3e%2042%0a%20%20%20%20the_answer%20%3c-%20the_answer%20%2b%20x%3b%0a%20%20%20%20PRINT%28the_answer%29%3b%20%2f%2f%20-%3e%2069%0a%7d%0a" target=_blank><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="#606060" d="M424.4 214.7 72.4 6.6C43.8-10.3.0 6.1.0 47.9V464c0 37.5 40.7 60.1 72.4 41.3l352-208c31.4-18.5 31.5-64.1.0-82.6z"/></svg></a><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Rust data-lang=Rust><span style=color:#579>#![allow(non_upper_case_globals, non_snake_case)]</span><span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#d42;background-color:#fff0f0>/// 4Ko RAM?
</span><span style=color:#d42;background-color:#fff0f0></span><span style=color:#080;font-weight:700>static</span><span style=color:#bbb> </span><span style=color:#080;font-weight:700>mut</span><span style=color:#bbb> </span>MEMORY: [<span style=color:#339;font-weight:700>u8</span>;<span style=color:#bbb> </span><span style=color:#00d;font-weight:700>4096</span>]<span style=color:#bbb> </span><span style=color:#333>=</span><span style=color:#bbb> </span>[<span style=color:#00d;font-weight:700>0</span>;<span style=color:#bbb> </span><span style=color:#00d;font-weight:700>4096</span>];<span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#080;font-weight:700>fn</span> <span style=color:#06b;font-weight:700>READ</span><span style=color:#bbb> </span>(whence: <span style=color:#b06;font-weight:700>address</span>)<span style=color:#bbb> </span>-&gt; <span style=color:#339;font-weight:700>u8</span>
{<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-weight:700>unsafe</span><span style=color:#bbb> </span>{<span style=color:#bbb> </span>MEMORY[whence]<span style=color:#bbb> </span>}<span style=color:#bbb>
</span><span style=color:#bbb></span>}<span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#080;font-weight:700>fn</span> <span style=color:#06b;font-weight:700>WRITE</span><span style=color:#bbb> </span>(where_to: <span style=color:#b06;font-weight:700>address</span>,<span style=color:#bbb> </span>what: <span style=color:#339;font-weight:700>u8</span>)<span style=color:#bbb>
</span><span style=color:#bbb></span>{<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-weight:700>unsafe</span><span style=color:#bbb> </span>{<span style=color:#bbb> </span>MEMORY[where_to]<span style=color:#bbb> </span><span style=color:#333>=</span><span style=color:#bbb> </span>what<span style=color:#bbb> </span>}<span style=color:#bbb>
</span><span style=color:#bbb></span>}<span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#d42;background-color:#fff0f0>/// Recursively replaces:
</span><span style=color:#d42;background-color:#fff0f0>///     the_answer =&gt; READ(at_the_answer)
</span><span style=color:#d42;background-color:#fff0f0>///     x          =&gt; READ(at_x)
</span><span style=color:#d42;background-color:#fff0f0></span>macro_rules<span style=color:#333>!</span><span style=color:#bbb> </span>replace_rvalues<span style=color:#bbb> </span>{<span style=color:#bbb>
</span><span style=color:#bbb>    </span>(<span style=color:#bbb>
</span><span style=color:#bbb>        </span>[<span style=color:#bbb> </span><span style=color:#579>$($replaced</span>:<span style=color:#b06;font-weight:700>tt</span>)<span style=color:#333>*</span><span style=color:#bbb> </span>]<span style=color:#bbb>
</span><span style=color:#bbb>        </span>the_answer<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:#579>$($rest</span>:<span style=color:#b06;font-weight:700>tt</span>)<span style=color:#333>*</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span>)<span style=color:#bbb> </span><span style=color:#333>=&gt;</span><span style=color:#bbb> </span>(replace_rvalues<span style=color:#333>!</span>(<span style=color:#bbb>
</span><span style=color:#bbb>        </span>[<span style=color:#bbb> </span><span style=color:#579>$($replaced</span>)<span style=color:#333>*</span><span style=color:#bbb> </span>READ(at_the_answer)<span style=color:#bbb> </span>]<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:#579>$($rest</span>)<span style=color:#333>*</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span>));<span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span>(<span style=color:#bbb>
</span><span style=color:#bbb>        </span>[<span style=color:#bbb> </span><span style=color:#579>$($replaced</span>:<span style=color:#b06;font-weight:700>tt</span>)<span style=color:#333>*</span><span style=color:#bbb> </span>]<span style=color:#bbb>
</span><span style=color:#bbb>        </span>x<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:#579>$($rest</span>:<span style=color:#b06;font-weight:700>tt</span>)<span style=color:#333>*</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span>)<span style=color:#bbb> </span><span style=color:#333>=&gt;</span><span style=color:#bbb> </span>(replace_rvalues<span style=color:#333>!</span>(<span style=color:#bbb>
</span><span style=color:#bbb>        </span>[<span style=color:#bbb> </span><span style=color:#579>$($replaced</span>)<span style=color:#333>*</span><span style=color:#bbb> </span>READ(at_x)<span style=color:#bbb> </span>]<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:#579>$($rest</span>)<span style=color:#333>*</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span>));<span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span>(<span style=color:#bbb>
</span><span style=color:#bbb>        </span>[<span style=color:#bbb> </span><span style=color:#579>$($replaced</span>:<span style=color:#b06;font-weight:700>tt</span>)<span style=color:#333>*</span><span style=color:#bbb> </span>]<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:#579>$tt</span>:<span style=color:#b06;font-weight:700>tt</span><span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:#579>$($rest</span>:<span style=color:#b06;font-weight:700>tt</span>)<span style=color:#333>*</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span>)<span style=color:#bbb> </span><span style=color:#333>=&gt;</span><span style=color:#bbb> </span>(replace_rvalues<span style=color:#333>!</span>(<span style=color:#bbb>
</span><span style=color:#bbb>        </span>[<span style=color:#bbb> </span><span style=color:#579>$($replaced</span>)<span style=color:#333>*</span><span style=color:#bbb> </span><span style=color:#579>$tt</span><span style=color:#bbb> </span>]<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:#579>$($rest</span>)<span style=color:#333>*</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span>));<span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span>(<span style=color:#bbb>
</span><span style=color:#bbb>        </span>[<span style=color:#bbb> </span><span style=color:#579>$($replaced</span>:<span style=color:#b06;font-weight:700>tt</span>)<span style=color:#333>*</span><span style=color:#bbb> </span>]<span style=color:#bbb>
</span><span style=color:#bbb>    </span>)<span style=color:#bbb> </span><span style=color:#333>=&gt;</span><span style=color:#bbb> </span>(<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:#579>$($replaced</span>)<span style=color:#333>*</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span>);<span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span>(<span style=color:#bbb> </span><span style=color:#579>$($tt</span>:<span style=color:#b06;font-weight:700>tt</span>)<span style=color:#333>*</span><span style=color:#bbb> </span>)<span style=color:#bbb> </span><span style=color:#333>=&gt;</span><span style=color:#bbb> </span>(<span style=color:#bbb>
</span><span style=color:#bbb>        </span>replace_rvalues<span style=color:#333>!</span>([]<span style=color:#bbb> </span><span style=color:#579>$($tt</span>)<span style=color:#333>*</span>)<span style=color:#bbb>
</span><span style=color:#bbb>    </span>)<span style=color:#bbb>
</span><span style=color:#bbb></span>}<span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb></span>macro_rules<span style=color:#333>!</span><span style=color:#bbb> </span>exec<span style=color:#bbb> </span>{<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#888>/* replaces */</span><span style=color:#bbb> </span>(<span style=color:#bbb>
</span><span style=color:#bbb>        </span>the_answer<span style=color:#bbb> </span><span style=color:#333>&lt;-</span><span style=color:#bbb> </span><span style=color:#579>$($tt</span>:<span style=color:#b06;font-weight:700>tt</span>)<span style=color:#333>*</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span>)<span style=color:#bbb> </span><span style=color:#333>=&gt;</span><span style=color:#bbb> </span><span style=color:#888>/* with */</span><span style=color:#bbb> </span>(<span style=color:#bbb>
</span><span style=color:#bbb>        </span>WRITE(at_the_answer,<span style=color:#bbb>
</span><span style=color:#bbb>            </span>replace_rvalues<span style=color:#333>!</span>(<span style=color:#bbb> </span><span style=color:#579>$($tt</span>)<span style=color:#333>*</span><span style=color:#bbb> </span>)<span style=color:#bbb>
</span><span style=color:#bbb>        </span>)<span style=color:#bbb>
</span><span style=color:#bbb>    </span>);<span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#888>/* replaces */</span><span style=color:#bbb> </span>(<span style=color:#bbb>
</span><span style=color:#bbb>        </span>x<span style=color:#bbb> </span><span style=color:#333>&lt;-</span><span style=color:#bbb> </span><span style=color:#579>$($tt</span>:<span style=color:#b06;font-weight:700>tt</span>)<span style=color:#333>*</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span>)<span style=color:#bbb> </span><span style=color:#333>=&gt;</span><span style=color:#bbb> </span><span style=color:#888>/* WITH */</span><span style=color:#bbb> </span>(<span style=color:#bbb>
</span><span style=color:#bbb>        </span>WRITE(at_x,<span style=color:#bbb>
</span><span style=color:#bbb>            </span>replace_rvalues<span style=color:#333>!</span>(<span style=color:#bbb> </span><span style=color:#579>$($tt</span>)<span style=color:#333>*</span><span style=color:#bbb> </span>)<span style=color:#bbb>
</span><span style=color:#bbb>        </span>)<span style=color:#bbb>
</span><span style=color:#bbb>    </span>);<span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#888>/* replaces */</span><span style=color:#bbb> </span>(<span style=color:#bbb>
</span><span style=color:#bbb>        </span>PRINT<span style=color:#bbb> </span>(<span style=color:#bbb> </span><span style=color:#579>$($tt</span>:<span style=color:#b06;font-weight:700>tt</span>)<span style=color:#333>*</span><span style=color:#bbb> </span>)<span style=color:#bbb>
</span><span style=color:#bbb>    </span>)<span style=color:#bbb> </span><span style=color:#333>=&gt;</span><span style=color:#bbb> </span><span style=color:#888>/* with */</span><span style=color:#bbb> </span>(<span style=color:#bbb>
</span><span style=color:#bbb>        </span>println<span style=color:#333>!</span>(<span style=background-color:#fff0f0>&#34;{} = {}&#34;</span>,<span style=color:#bbb> </span>stringify<span style=color:#333>!</span>(<span style=color:#579>$($tt</span>)<span style=color:#333>*</span>),<span style=color:#bbb> </span>replace_rvalues<span style=color:#333>!</span>(<span style=color:#bbb> </span><span style=color:#579>$($tt</span>)<span style=color:#333>*</span><span style=color:#bbb> </span>));<span style=color:#bbb>
</span><span style=color:#bbb>    </span>);<span style=color:#bbb>
</span><span style=color:#bbb></span>}<span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb></span>macro_rules<span style=color:#333>!</span><span style=color:#bbb> </span>main<span style=color:#bbb> </span>{<span style=color:#bbb>
</span><span style=color:#bbb>    </span>(<span style=color:#333>@</span>parsing<span style=color:#bbb>
</span><span style=color:#bbb>        </span>[<span style=color:#bbb> </span><span style=color:#579>$($stmts</span>:<span style=color:#b06;font-weight:700>tt</span>)<span style=color:#333>*</span><span style=color:#bbb> </span>]<span style=color:#bbb>
</span><span style=color:#bbb>        </span>[<span style=color:#bbb> </span><span style=color:#579>$($current</span>:<span style=color:#b06;font-weight:700>tt</span>)<span style=color:#333>*</span><span style=color:#bbb> </span>]<span style=color:#bbb>
</span><span style=color:#bbb>        </span>;<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:#579>$($rest</span>:<span style=color:#b06;font-weight:700>tt</span>)<span style=color:#333>*</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span>)<span style=color:#bbb> </span><span style=color:#333>=&gt;</span><span style=color:#bbb> </span>(main<span style=color:#333>!</span>{<span style=color:#333>@</span>parsing<span style=color:#bbb>
</span><span style=color:#bbb>        </span>[<span style=color:#bbb> </span><span style=color:#579>$($stmts</span>)<span style=color:#333>*</span><span style=color:#bbb> </span>(<span style=color:#bbb> </span><span style=color:#579>$($current</span>)<span style=color:#333>*</span><span style=color:#bbb> </span>)<span style=color:#bbb> </span>]<span style=color:#bbb>
</span><span style=color:#bbb>        </span>[]<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:#579>$($rest</span>)<span style=color:#333>*</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span>});<span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span>(<span style=color:#333>@</span>parsing<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:#579>$stmts</span>:<span style=color:#b06;font-weight:700>tt</span><span style=color:#bbb>
</span><span style=color:#bbb>        </span>[<span style=color:#bbb> </span><span style=color:#579>$($current</span>:<span style=color:#b06;font-weight:700>tt</span>)<span style=color:#333>*</span><span style=color:#bbb> </span>]<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:#579>$tt</span>:<span style=color:#b06;font-weight:700>tt</span><span style=color:#bbb> </span><span style=color:#579>$($rest</span>:<span style=color:#b06;font-weight:700>tt</span>)<span style=color:#333>*</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span>)<span style=color:#bbb> </span><span style=color:#333>=&gt;</span><span style=color:#bbb> </span>(main<span style=color:#333>!</span>{<span style=color:#333>@</span>parsing<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:#579>$stmts</span><span style=color:#bbb>
</span><span style=color:#bbb>        </span>[<span style=color:#bbb> </span><span style=color:#579>$($current</span>)<span style=color:#333>*</span><span style=color:#bbb> </span><span style=color:#579>$tt</span>]<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:#579>$($rest</span>)<span style=color:#333>*</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span>});<span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span>(<span style=color:#333>@</span>parsing<span style=color:#bbb>
</span><span style=color:#bbb>        </span>[<span style=color:#bbb> </span><span style=color:#579>$(</span><span style=color:#bbb> </span>(<span style=color:#bbb> </span><span style=color:#579>$($stmts</span>:<span style=color:#b06;font-weight:700>tt</span>)<span style=color:#333>*</span><span style=color:#bbb> </span>)<span style=color:#bbb> </span>)<span style=color:#333>*</span><span style=color:#bbb> </span>]<span style=color:#bbb>
</span><span style=color:#bbb>        </span>[]<span style=color:#bbb>
</span><span style=color:#bbb>    </span>)<span style=color:#bbb> </span><span style=color:#333>=&gt;</span><span style=color:#bbb> </span>(<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:#080;font-weight:700>fn</span> <span style=color:#06b;font-weight:700>main</span><span style=color:#bbb> </span>()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:#579>$(</span><span style=color:#bbb>
</span><span style=color:#bbb>                </span>exec<span style=color:#333>!</span>{<span style=color:#bbb> </span><span style=color:#579>$($stmts</span>)<span style=color:#333>*</span><span style=color:#bbb> </span>}<span style=color:#bbb>
</span><span style=color:#bbb>            </span>)<span style=color:#333>*</span><span style=color:#bbb>
</span><span style=color:#bbb>        </span>}<span style=color:#bbb>
</span><span style=color:#bbb>    </span>);<span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span>(<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:#579>$($tt</span>:<span style=color:#b06;font-weight:700>tt</span>)<span style=color:#333>*</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span>)<span style=color:#bbb> </span><span style=color:#333>=&gt;</span><span style=color:#bbb> </span>(main<span style=color:#333>!</span>{<span style=color:#333>@</span>parsing<span style=color:#bbb>
</span><span style=color:#bbb>        </span>[]<span style=color:#bbb>
</span><span style=color:#bbb>        </span>[]<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:#579>$($tt</span>)<span style=color:#333>*</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span>});<span style=color:#bbb>
</span><span style=color:#bbb></span>}<span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#579>#[allow(non_camel_case_types)]</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#080;font-weight:700>type</span> <span style=color:#b06;font-weight:700>address</span><span style=color:#bbb> </span><span style=color:#333>=</span><span style=color:#bbb> </span><span style=color:#339;font-weight:700>usize</span>;<span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#080;font-weight:700>const</span><span style=color:#bbb> </span>at_the_answer: <span style=color:#b06;font-weight:700>address</span><span style=color:#bbb> </span><span style=color:#333>=</span><span style=color:#bbb> </span><span style=color:#00d;font-weight:700>1000</span>;<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#080;font-weight:700>const</span><span style=color:#bbb> </span>at_x: <span style=color:#b06;font-weight:700>address</span><span style=color:#bbb> </span><span style=color:#333>=</span><span style=color:#bbb> </span><span style=color:#00d;font-weight:700>1001</span>;<span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb></span>main<span style=color:#333>!</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span><span style=color:#bbb>    </span>the_answer<span style=color:#bbb> </span><span style=color:#333>&lt;-</span><span style=color:#bbb> </span><span style=color:#00d;font-weight:700>42</span>;<span style=color:#bbb>
</span><span style=color:#bbb>    </span>x<span style=color:#bbb> </span><span style=color:#333>&lt;-</span><span style=color:#bbb> </span><span style=color:#00d;font-weight:700>27</span>;<span style=color:#bbb>
</span><span style=color:#bbb>    </span>PRINT(the_answer);<span style=color:#bbb> </span><span style=color:#888>// -&gt; 42
</span><span style=color:#888></span><span style=color:#bbb>    </span>the_answer<span style=color:#bbb> </span><span style=color:#333>&lt;-</span><span style=color:#bbb> </span>the_answer<span style=color:#bbb> </span><span style=color:#333>+</span><span style=color:#bbb> </span>x;<span style=color:#bbb>
</span><span style=color:#bbb>    </span>PRINT(the_answer);<span style=color:#bbb> </span><span style=color:#888>// -&gt; 69
</span><span style=color:#888></span>}<span style=color:#bbb>
</span></code></pre></div><div class=footnotes><hr><ol><li id=fn:1><em>i.e.</em>, on runtime
<a class=footnote-return href=#fnref:1><sup>[return]</sup></a></li><li id=fn:2>The representation of a number (here in base ten) vs its <em>true</em> nature is a (very interesting) topic in and on itself, which will most probably deserve its own blog post. One great definition / view of a (natural) number&rsquo;s nature is Peano&rsquo;s arithmetic, with which one can <em>prove</em> that <code>1+1+0 + 1+1+0 = 1+1+1+1+0</code>
<a class=footnote-return href=#fnref:2><sup>[return]</sup></a></li><li id=fn:3><code>const</code> does not declare a <em>variable</em>, but a meta <em>binding</em>.
<a class=footnote-return href=#fnref:3><sup>[return]</sup></a></li><li id=fn:4>and <code>.bss</code> for initially zero-ed (global) memory
<a class=footnote-return href=#fnref:4><sup>[return]</sup></a></li><li id=fn:5>and pattern bindings such as <code>match</code> arms or function parameters
<a class=footnote-return href=#fnref:5><sup>[return]</sup></a></li><li id=fn:6>or can even use just one register (since the allocations are all static)
<a class=footnote-return href=#fnref:6><sup>[return]</sup></a></li><li id=fn:7>offsets are actually negative and do not start at 0, but those are just implementation details
<a class=footnote-return href=#fnref:7><sup>[return]</sup></a></li><li id=fn:8>accessing the memory at a given address
<a class=footnote-return href=#fnref:8><sup>[return]</sup></a></li></ol></div></div><div class=prev-next><a class="prev-next-link prev-link" href=/posts/2019-02-19-mutation-part-0-intro/><button class="button prev-button">
<span>Prev post</span></button></a>
<a class="prev-next-link next-link" href=/posts/2019-02-24-mutation-part-2-to-mut-or-not-to-mut/><button class="button next-button">
<span>Next post</span></button></a></div></main></body></html>